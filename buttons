(function () {
    var toggleKey = 'lme_showbuttonwn';
    var settingsGroup = 'lme_buttonfix';

    function renderButtons() {
        Lampa.Listener.follow('full', function (e) {
            if (e.type !== 'complite') return;

            setTimeout(function () {
                var activity = e.object && e.object.activity;
                if (!activity || typeof activity.render !== 'function') return;

                var fullContainer = activity.render();
                if (!fullContainer || !fullContainer.length) return;

                var targetContainer = fullContainer.find('.full-start-new__buttons');
                if (!targetContainer.length) return;

                fullContainer.find('.button--play').remove();

                var allButtons = fullContainer.find('.buttons--container .full-start__button')
                    .add(targetContainer.find('.full-start__button'));

                var categories = {
                    online: [],
                    torrent: [],
                    trailer: [],
                    other: []
                };

                allButtons.each(function (i, el) {
                    var $btn = $(el);
                    var className = $btn.attr('class') || '';

                    if (className.indexOf('online') !== -1) {
                        categories.online.push($btn);
                    } else if (className.indexOf('torrent') !== -1) {
                        categories.torrent.push($btn);
                    } else if (className.indexOf('trailer') !== -1) {
                        categories.trailer.push($btn);
                    } else {
                        categories.other.push($btn.clone(true));
                    }
                });

                var buttonSortOrder = Lampa.Storage.get('lme_buttonsort');
                if (!buttonSortOrder || !Array.isArray(buttonSortOrder)) {
                    buttonSortOrder = ['torrent', 'online', 'trailer', 'other'];
                }

                targetContainer.empty();
                for (var i = 0; i < buttonSortOrder.length; i++) {
                    var cat = buttonSortOrder[i];
                    var buttons = categories[cat] || [];
                    for (var j = 0; j < buttons.length; j++) {
                        targetContainer.append(buttons[j]);
                    }
                }

                if (Lampa.Storage.get(toggleKey) === true) {
                    targetContainer.find('span').remove();
                }

                targetContainer.css({
                    display: 'flex',
                    flexWrap: 'wrap',
                    gap: '10px'
                });

                Lampa.Controller.toggle('full_start');
            }, 100);
        });
    }

    function addSettingsToggle() {
        Lampa.Settings.listener.follow('open', function (e) {
            if (e.name !== 'more') return;

            var currentValue = Lampa.Storage.get(toggleKey) === true;

            Lampa.Settings.add({
                component: settingsGroup,
                name: 'Кнопки: скрыть текст',
                type: 'toggle',
                value: currentValue,
                onchange: function (val) {
                    Lampa.Storage.set(toggleKey, val);
                }
            });
        });

        Lampa.Settings.group.add({
            title: 'Кнопки просмотра',
            component: settingsGroup
        });
    }

    function initPlugin() {
        renderButtons();
        addSettingsToggle();
    }

    initPlugin();
})();
